# Template Generator Refactor Design Document

## Overview

This design addresses critical syntax errors and architectural inconsistencies in the git-template system's template generation process. The preferred approach is demonstrated in `templated/examples/rails8-simple/.git_template/template.rb`, which uses a simple, direct generator pattern with proper load path management and class method execution.

The core issue is that the current broken templates attempt to use complex instance-based generator patterns with invalid syntax, while the preferred template uses a straightforward approach with proper Ruby syntax, correct load path setup, and direct generator class execution. This design will establish the preferred pattern as the standard and refactor all template generation to use this approach.

## Architecture

### Preferred Working Pattern

Notes:

repo_path AND golden_text TEMPLATE DSL methods added by GitTemplate::Generators::Base

```ruby
# Rails Template
# Generated by git-template regenerate-template command
# Generated at: 2025-12-19 06:55:19

lib_path = File.join(File.dirname(__FILE__), '..', '..', '..', '..', 'lib')
puts "Adding to load path: #{lib_path}"
puts "Resolved path: #{File.expand_path(lib_path)}"
$LOAD_PATH.unshift(lib_path)

puts "Generating GemBundle0001"

require 'git_template/generators/base'
require 'git_template/generators/gem_bundle'

class GemBundle0001 < GitTemplate::Generators::Base
  include GitTemplate::Generators::GemBundle
  
  repo_path "./Gemfile"
  golden_text <<-TEXT
source "https://rubygems.org"

# Bundle edge Rails instead: gem "rails", github: "rails/rails", branch: "main"
gem "rails", "~> 8.1.1"
# ... gem content continues
    TEXT
  end
end

GemBundle0001.generate

puts "Template application completed!"
```

### Current Broken Pattern (to be fixed)
```ruby
# Incorrect load path manipulation
lib_path = File.join(File.dirname(__FILE__), '..', '..', '..', '..', 'lib')
$LOAD_PATH.unshift(lib_path)
generators::GitTemplate::Generators  # Invalid syntax - not a valid statement

# Incorrect instance-based pattern
class GemBundle0001 < generators::Base  # Invalid class reference - should be GitTemplate::Generators::Base
  include generators:GemBundle          # Invalid syntax - should be :: not :
  gem_bundle_meta {                     # Should be a method definition, not a block
    id: "#{self}"
  }
  gem_bundle_text <<-TEXT              # Should be a method definition
    # ... content
  TEXT
end

generator.generate  # Invalid - no generator variable defined, should be GemBundle0001.generate
```

### Target Architecture
The refactored system will use the proven pattern from the working template:

1. **Load Path Management**: Proper setup of Ruby load paths to find generator modules
2. **Generator Class Definition**: Classes that inherit from GitTemplate::Generators::Base and include appropriate mixins
3. **Direct Generator Execution**: Simple class method calls to generate output
4. **Minimal Template Structure**: Clean, straightforward template files without complex orchestration

## Components and Interfaces

### Template File Interface
```ruby
# Standard template file structure following the preferred pattern
# 1. Header with metadata
# 2. Load path setup
# 3. Generator class definition with proper inheritance and mixins
# 4. Direct generator execution

# Rails Template
# Generated by git-template regenerate-template command
# Generated at: [timestamp]

lib_path = File.join(File.dirname(__FILE__), '..', '..', '..', '..', 'lib')
puts "Adding to load path: #{lib_path}"
$LOAD_PATH.unshift(lib_path)

require 'base'
require '[generator_module]'

class [GeneratorClass] < GitTemplate::Generators::Base
  include GitTemplate::Generators::[GeneratorModule]
  
  def self.[generator_method]
    # Generator-specific configuration
  end
end

[GeneratorClass].generate
```

### Generator Module Interface
```ruby
module GitTemplate
  module Generators
    module [GeneratorModule]
      # Mixin methods that provide generator functionality
      # Used by template classes that include this module
      
      def self.included(base)
        # Setup when module is included
      end
      
      # Generator-specific methods available to including classes
    end
    
    class Base
      def self.generate
        # Base generation logic that calls generator-specific methods
      end
    end
  end
end
```

### Metadata and Tracing Interface
```ruby
# Generated output includes tracing comments
# Generated by: GitTemplate::Generators::[GeneratorName]
# Generated at: [timestamp]
# Source: [file_path]:[line_number]
# Git commit: [commit_hash]
```

## Data Models

### Template Configuration Model
```ruby
class TemplateConfiguration
  attr_reader :generators, :metadata, :phases
  
  def initialize
    @generators = discover_generators
    @metadata = build_metadata
    @phases = organize_by_phases
  end
end
```

### Generator Metadata Model
```ruby
class GeneratorMetadata
  attr_reader :name, :phase, :class_name, :file_path, :dependencies
  
  def initialize(generator_info)
    @name = generator_info[:name]
    @phase = generator_info[:phase]
    @class_name = generator_info[:class_name]
    @file_path = generator_info[:file_path]
    @dependencies = generator_info[:dependencies] || []
  end
end
```

### Template Generation Result Model
```ruby
class TemplateGenerationResult
  attr_reader :success, :generated_files, :errors, :metadata
  
  def initialize
    @success = true
    @generated_files = []
    @errors = []
    @metadata = {}
  end
end
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Valid Ruby Syntax
*For any* generated template file, parsing the file with Ruby's syntax parser should succeed without syntax errors, and all module references should use correct double-colon (::) syntax, all class definitions should use proper inheritance syntax, and all require statements should reference existing files.
**Validates: Requirements 1.1, 1.2, 1.3, 1.4, 1.5**

### Property 2: Consistent Generator Execution
*For any* template file containing generators, all generator executions should use the direct class method pattern (ClassName.generate) with proper inheritance from GitTemplate::Generators::Base and appropriate module inclusion, and this pattern should be consistent across all generators.
**Validates: Requirements 2.1, 2.2, 2.4, 5.1**

### Property 3: Resolvable Module References
*For any* generator reference in a template file, the fully qualified module name should resolve to an actual loaded class after all require statements are processed.
**Validates: Requirements 3.3, 1.2**

### Property 4: Valid Dependency Loading
*For any* template file, all require_relative paths should resolve to existing files, and all dependencies should be loaded before any generator execution statements.
**Validates: Requirements 3.2, 3.4, 1.4**

### Property 5: Cross-Generator Consistency
*For any* set of generators in a template, all generators should use the same patterns for parameter passing, output handling, logging, and error handling.
**Validates: Requirements 5.2, 5.3, 5.4, 5.5**

### Property 6: Generator Modularity
*For any* template file, removing a generator's require and execute statements should not affect the execution of other generators in the template.
**Validates: Requirements 6.5**

### Property 7: Comprehensive Metadata Tracing
*For any* output generated by a template generator, the output should include metadata comments that identify the generating module, generation timestamp, and source file location, enabling tracing from any generated line back to its source generator.
**Validates: Requirements 7.1, 7.2, 7.3, 7.4, 7.5**

### Property 8: Template Syntax Correction
*For any* broken template file, after applying the refactoring process, the file should use the same direct generator pattern as the preferred template, have correct module namespace syntax with proper :: separators, use proper load path setup and require statements, contain proper class definitions with inheritance and module inclusion, and produce functionally equivalent output to the working template.
**Validates: Requirements 8.1, 8.2, 8.3, 8.4, 8.5**

### Property 9: Generator Addition Extensibility
*For any* new generator added to the system, the template file should be able to incorporate it using the same require_relative and class method execution pattern as existing generators without requiring changes to other generator calls.
**Validates: Requirements 6.4**

### Property 10: Error Message Clarity
*For any* generator execution failure or module loading failure, the error message should include the specific generator name or module name that failed, enabling quick identification of the problem source.
**Validates: Requirements 2.5, 3.5**

## Error Handling

### Template Generation Errors
- **Syntax Errors**: If generated template contains syntax errors, the system will validate using Ruby parser and report specific line numbers and error messages
- **Module Loading Errors**: If require_relative fails, the system will report the missing file path and suggest corrections
- **Generator Execution Errors**: If a generator fails during execution, the system will catch the exception, log the generator name and error details, and continue with remaining generators

### Generator Discovery Errors
- **Missing Generator Files**: If a generator file is referenced but doesn't exist, the system will report the expected file path
- **Invalid Generator Classes**: If a generator class doesn't implement the required interface, the system will report the missing methods
- **Circular Dependencies**: If generators have circular dependencies, the system will detect and report the dependency cycle

### Configuration Errors
- **Invalid Configuration**: If generator configuration is malformed, the system will validate and report specific configuration errors
- **Missing Required Parameters**: If a generator requires parameters that aren't provided, the system will report the missing parameters

## Testing Strategy

### Unit Testing Approach

Unit tests will focus on specific components and their interactions:

1. **Template File Parsing Tests**
   - Test that generated templates can be parsed by Ruby without syntax errors
   - Test that module references use correct syntax
   - Test that require_relative paths resolve correctly

2. **Generator Execution Tests**
   - Test that generators are called with class method pattern
   - Test that generator execution produces expected output
   - Test that generator errors are handled correctly

3. **Metadata Generation Tests**
   - Test that generated files include proper metadata headers
   - Test that metadata includes all required fields (generator name, timestamp, source location)
   - Test that metadata format is consistent across generators

4. **Template Refactoring Tests**
   - Test that broken template patterns are correctly identified
   - Test that refactoring produces valid template syntax
   - Test that refactored templates produce equivalent output

### Property-Based Testing Approach

Property-based tests will verify universal properties across all inputs using the `rspec-parameterized` gem for Ruby. Each property test will run a minimum of 100 iterations with randomly generated inputs.

1. **Property 1: Valid Ruby Syntax**
   - Generate random template files with various generator combinations
   - Verify all generated templates parse without syntax errors
   - Verify all module references use correct :: syntax

2. **Property 2: Consistent Class Method Execution**
   - Generate templates with random numbers of generators
   - Verify all generators use ClassName.execute pattern
   - Verify no instance creation patterns exist

3. **Property 3: Resolvable Module References**
   - Generate templates with random generator references
   - Verify all module names resolve after loading
   - Verify no undefined constant errors occur

4. **Property 4: Valid Dependency Loading**
   - Generate templates with random require_relative statements
   - Verify all paths resolve to existing files
   - Verify dependencies load before execution

5. **Property 5: Cross-Generator Consistency**
   - Generate templates with multiple generators
   - Verify consistent patterns across all generators
   - Verify parameter passing, logging, and error handling consistency

6. **Property 6: Generator Modularity**
   - Generate templates with random generator subsets
   - Remove random generators and verify others still work
   - Verify no cross-generator dependencies

7. **Property 7: Comprehensive Metadata Tracing**
   - Generate random generator outputs
   - Verify all outputs include metadata comments
   - Verify metadata enables tracing to source

8. **Property 8: Template Syntax Correction**
   - Generate broken templates with various syntax errors
   - Apply refactoring and verify correct syntax
   - Verify functional equivalence to working templates

9. **Property 9: Generator Addition Extensibility**
   - Add random new generators to templates
   - Verify templates incorporate them correctly
   - Verify existing generators unaffected

10. **Property 10: Error Message Clarity**
    - Trigger random generator failures
    - Verify error messages include generator identification
    - Verify error messages enable quick problem identification

### Integration Testing

Integration tests will verify the complete template generation workflow:

1. **End-to-End Template Generation**
   - Generate complete templates from generator registry
   - Execute generated templates in test Rails applications
   - Verify generated applications function correctly

2. **Template Refactoring Workflow**
   - Load broken templates
   - Apply refactoring process
   - Verify refactored templates execute successfully

3. **Generator Registry Integration**
   - Discover generators from file system
   - Generate templates using discovered generators
   - Verify all generators execute in correct order

## Implementation Notes

### Refactoring Strategy

1. **Phase 1: Fix Immediate Syntax Errors**
   - Fix broken templates to use correct load path setup
   - Fix module references to use proper :: syntax
   - Fix class definitions to inherit from GitTemplate::Generators::Base
   - Fix method definitions to be proper class methods
   - Fix generator execution to use ClassName.generate pattern

2. **Phase 2: Standardize Template Generation**
   - Update template generation code to use the preferred pattern
   - Ensure consistent load path management
   - Ensure consistent class definition and module inclusion patterns

3. **Phase 3: Add Metadata and Tracing**
   - Add metadata comments to all generated output
   - Add tracing markers for debugging
   - Ensure metadata includes all required fields

4. **Phase 4: Improve Error Handling**
   - Add clear error messages for all failure modes
   - Add validation for template syntax
   - Add validation for generator interfaces

### Backward Compatibility

The refactoring will maintain backward compatibility with existing generator modules:
- Existing generator modules will continue to work as mixins
- The Base class and module inclusion pattern is already established
- Generator modules provide the same functionality through mixin methods
- No changes to core generator logic are required

### Performance Considerations

- Template generation is a one-time operation, so performance is not critical
- Generator execution should complete in seconds for typical templates
- Metadata generation adds minimal overhead

### Security Considerations

- Template files execute arbitrary Ruby code, so they should only be generated from trusted sources
- Generated templates should not include sensitive information in metadata comments
- File paths in require_relative should be validated to prevent directory traversal